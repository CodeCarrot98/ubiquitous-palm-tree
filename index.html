import React, { useState, useEffect, useRef } from 'react';
import { Search, X, Globe, Clock, MapPin } from 'lucide-react';

// Comprehensive timezone database
const timezoneData = {
  // North America
  "New York, USA": "America/New_York",
  "Los Angeles, USA": "America/Los_Angeles",
  "Chicago, USA": "America/Chicago",
  "Toronto, Canada": "America/Toronto",
  "Vancouver, Canada": "America/Vancouver",
  "Mexico City, Mexico": "America/Mexico_City",
  "Miami, USA": "America/New_York",
  "San Francisco, USA": "America/Los_Angeles",
  "Boston, USA": "America/New_York",
  "Seattle, USA": "America/Los_Angeles",
  "Denver, USA": "America/Denver",
  "Phoenix, USA": "America/Phoenix",
  "Dallas, USA": "America/Chicago",
  "Houston, USA": "America/Chicago",
  "Montreal, Canada": "America/Toronto",
  
  // South America
  "SÃ£o Paulo, Brazil": "America/Sao_Paulo",
  "Buenos Aires, Argentina": "America/Argentina/Buenos_Aires",
  "Rio de Janeiro, Brazil": "America/Sao_Paulo",
  "Lima, Peru": "America/Lima",
  "Bogota, Colombia": "America/Bogota",
  "Santiago, Chile": "America/Santiago",
  "Caracas, Venezuela": "America/Caracas",
  
  // Europe
  "London, UK": "Europe/London",
  "Paris, France": "Europe/Paris",
  "Berlin, Germany": "Europe/Berlin",
  "Madrid, Spain": "Europe/Madrid",
  "Rome, Italy": "Europe/Rome",
  "Amsterdam, Netherlands": "Europe/Amsterdam",
  "Brussels, Belgium": "Europe/Brussels",
  "Vienna, Austria": "Europe/Vienna",
  "Stockholm, Sweden": "Europe/Stockholm",
  "Copenhagen, Denmark": "Europe/Copenhagen",
  "Oslo, Norway": "Europe/Oslo",
  "Helsinki, Finland": "Europe/Helsinki",
  "Warsaw, Poland": "Europe/Warsaw",
  "Prague, Czech Republic": "Europe/Prague",
  "Budapest, Hungary": "Europe/Budapest",
  "Athens, Greece": "Europe/Athens",
  "Lisbon, Portugal": "Europe/Lisbon",
  "Dublin, Ireland": "Europe/Dublin",
  "Zurich, Switzerland": "Europe/Zurich",
  "Moscow, Russia": "Europe/Moscow",
  
  // Asia
  "Tokyo, Japan": "Asia/Tokyo",
  "Beijing, China": "Asia/Shanghai",
  "Shanghai, China": "Asia/Shanghai",
  "Hong Kong": "Asia/Hong_Kong",
  "Singapore": "Asia/Singapore",
  "Seoul, South Korea": "Asia/Seoul",
  "Mumbai, India": "Asia/Kolkata",
  "Delhi, India": "Asia/Kolkata",
  "Bangalore, India": "Asia/Kolkata",
  "Bangkok, Thailand": "Asia/Bangkok",
  "Jakarta, Indonesia": "Asia/Jakarta",
  "Manila, Philippines": "Asia/Manila",
  "Kuala Lumpur, Malaysia": "Asia/Kuala_Lumpur",
  "Taipei, Taiwan": "Asia/Taipei",
  "Ho Chi Minh City, Vietnam": "Asia/Ho_Chi_Minh",
  "Dubai, UAE": "Asia/Dubai",
  "Tel Aviv, Israel": "Asia/Jerusalem",
  "Riyadh, Saudi Arabia": "Asia/Riyadh",
  "Istanbul, Turkey": "Europe/Istanbul",
  "Karachi, Pakistan": "Asia/Karachi",
  
  // Oceania
  "Sydney, Australia": "Australia/Sydney",
  "Melbourne, Australia": "Australia/Melbourne",
  "Brisbane, Australia": "Australia/Brisbane",
  "Perth, Australia": "Australia/Perth",
  "Auckland, New Zealand": "Pacific/Auckland",
  "Wellington, New Zealand": "Pacific/Auckland",
  
  // Africa
  "Cairo, Egypt": "Africa/Cairo",
  "Lagos, Nigeria": "Africa/Lagos",
  "Johannesburg, South Africa": "Africa/Johannesburg",
  "Nairobi, Kenya": "Africa/Nairobi",
  "Casablanca, Morocco": "Africa/Casablanca",
  "Accra, Ghana": "Africa/Accra",
  "Addis Ababa, Ethiopia": "Africa/Addis_Ababa",
  "Algiers, Algeria": "Africa/Algiers",
  "Tunis, Tunisia": "Africa/Tunis",
};

const WorldClock = () => {
  const [clocks, setClocks] = useState([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [filteredCities, setFilteredCities] = useState([]);
  const [showDropdown, setShowDropdown] = useState(false);
  const [currentTime, setCurrentTime] = useState(new Date());
  const searchRef = useRef(null);

  // Initialize with local time
  useEffect(() => {
    const localTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    const localCity = localTimezone.split('/').pop().replace(/_/g, ' ');
    
    setClocks([{
      id: Date.now(),
      city: `${localCity} (Local)`,
      timezone: localTimezone,
      isLocal: true
    }]);

    // Load saved clocks from localStorage
    const saved = localStorage.getItem('worldClocks');
    if (saved) {
      try {
        const savedClocks = JSON.parse(saved);
        setClocks(prev => [...prev, ...savedClocks.filter(c => !c.isLocal)]);
      } catch (e) {
        console.error('Error loading saved clocks:', e);
      }
    }
  }, []);

  // Update time every second
  useEffect(() => {
    const timer = setInterval(() => {
      setCurrentTime(new Date());
    }, 1000);
    return () => clearInterval(timer);
  }, []);

  // Save clocks to localStorage
  useEffect(() => {
    const nonLocalClocks = clocks.filter(c => !c.isLocal);
    if (nonLocalClocks.length > 0) {
      localStorage.setItem('worldClocks', JSON.stringify(nonLocalClocks));
    }
  }, [clocks]);

  // Handle search input
  useEffect(() => {
    if (searchQuery.trim()) {
      const filtered = Object.keys(timezoneData)
        .filter(city => 
          city.toLowerCase().includes(searchQuery.toLowerCase())
        )
        .slice(0, 8);
      setFilteredCities(filtered);
      setShowDropdown(filtered.length > 0);
    } else {
      setFilteredCities([]);
      setShowDropdown(false);
    }
  }, [searchQuery]);

  // Close dropdown when clicking outside
  useEffect(() => {
    const handleClickOutside = (e) => {
      if (searchRef.current && !searchRef.current.contains(e.target)) {
        setShowDropdown(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  const addClock = (city) => {
    const timezone = timezoneData[city];
    const exists = clocks.some(c => c.timezone === timezone);
    
    if (!exists) {
      setClocks([...clocks, {
        id: Date.now(),
        city,
        timezone,
        isLocal: false
      }]);
    }
    
    setSearchQuery('');
    setShowDropdown(false);
  };

  const removeClock = (id) => {
    setClocks(clocks.filter(c => c.id !== id));
  };

  const formatTime = (timezone) => {
    return new Intl.DateTimeFormat('en-US', {
      timeZone: timezone,
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: true
    }).format(currentTime);
  };

  const formatDate = (timezone) => {
    return new Intl.DateTimeFormat('en-US', {
      timeZone: timezone,
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    }).format(currentTime);
  };

  const getTimeOfDay = (timezone) => {
    const hour = parseInt(new Intl.DateTimeFormat('en-US', {
      timeZone: timezone,
      hour: '2-digit',
      hour12: false
    }).format(currentTime));
    
    if (hour >= 6 && hour < 12) return 'morning';
    if (hour >= 12 && hour < 18) return 'afternoon';
    if (hour >= 18 && hour < 22) return 'evening';
    return 'night';
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-900 via-slate-900 to-gray-900 text-white p-4 md:p-8">
      {/* Header */}
      <div className="max-w-7xl mx-auto mb-8">
        <div className="flex items-center justify-center mb-2">
          <Globe className="w-10 h-10 mr-3 text-blue-400" />
          <h1 className="text-4xl md:text-5xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
            World Clock
          </h1>
        </div>
        <p className="text-center text-gray-400 text-sm">Track time across the globe</p>
      </div>

      {/* Search Bar */}
      <div className="max-w-2xl mx-auto mb-12 relative" ref={searchRef}>
        <div className="relative">
          <Search className="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
          <input
            type="text"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            placeholder="Search for any city..."
            className="w-full bg-gray-800 border border-gray-700 rounded-xl pl-12 pr-4 py-4 text-white placeholder-gray-500 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition-all"
          />
        </div>

        {/* Autocomplete Dropdown */}
        {showDropdown && (
          <div className="absolute w-full mt-2 bg-gray-800 border border-gray-700 rounded-xl shadow-2xl overflow-hidden z-10 max-h-80 overflow-y-auto">
            {filteredCities.map((city, idx) => (
              <button
                key={idx}
                onClick={() => addClock(city)}
                className="w-full text-left px-4 py-3 hover:bg-gray-700 transition-colors flex items-center group"
              >
                <MapPin className="w-4 h-4 mr-3 text-gray-500 group-hover:text-blue-400 transition-colors" />
                <span className="text-white">{city}</span>
              </button>
            ))}
          </div>
        )}
      </div>

      {/* Clocks Grid */}
      {clocks.length === 0 ? (
        <div className="text-center py-20">
          <Clock className="w-16 h-16 mx-auto mb-4 text-gray-600" />
          <p className="text-gray-500 text-lg">No clocks yet. Search for a city to get started!</p>
        </div>
      ) : (
        <div className="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {clocks.map((clock) => {
            const timeOfDay = getTimeOfDay(clock.timezone);
            const gradients = {
              morning: 'from-orange-500/20 to-yellow-500/20',
              afternoon: 'from-blue-500/20 to-cyan-500/20',
              evening: 'from-purple-500/20 to-pink-500/20',
              night: 'from-indigo-500/20 to-blue-900/20'
            };

            return (
              <div
                key={clock.id}
                className={`relative bg-gradient-to-br ${gradients[timeOfDay]} backdrop-blur-sm border border-gray-700/50 rounded-2xl p-6 shadow-xl hover:shadow-2xl transition-all duration-300 hover:scale-105 group`}
              >
                {/* Remove Button */}
                {!clock.isLocal && (
                  <button
                    onClick={() => removeClock(clock.id)}
                    className="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity bg-red-500/20 hover:bg-red-500/40 rounded-full p-2"
                  >
                    <X className="w-4 h-4 text-red-400" />
                  </button>
                )}

                {/* City Name */}
                <div className="mb-4">
                  <h3 className="text-xl font-semibold text-white flex items-center">
                    <MapPin className="w-5 h-5 mr-2 text-blue-400" />
                    {clock.city}
                  </h3>
                </div>

                {/* Time Display */}
                <div className="mb-3">
                  <div className="text-5xl font-bold text-white tracking-tight font-mono">
                    {formatTime(clock.timezone)}
                  </div>
                </div>

                {/* Date Display */}
                <div className="text-gray-400 text-sm">
                  {formatDate(clock.timezone)}
                </div>

                {/* Time of Day Indicator */}
                <div className="absolute bottom-4 right-4">
                  <div className={`text-xs px-3 py-1 rounded-full ${
                    timeOfDay === 'morning' ? 'bg-yellow-500/20 text-yellow-300' :
                    timeOfDay === 'afternoon' ? 'bg-blue-500/20 text-blue-300' :
                    timeOfDay === 'evening' ? 'bg-purple-500/20 text-purple-300' :
                    'bg-indigo-500/20 text-indigo-300'
                  }`}>
                    {timeOfDay}
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      )}

      {/* Footer */}
      <div className="max-w-7xl mx-auto mt-16 text-center text-gray-500 text-sm">
        <p>Tracking time across {Object.keys(timezoneData).length}+ cities worldwide</p>
      </div>
    </div>
  );
};

export default WorldClock;
